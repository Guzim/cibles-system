<!DOCTYPE html>

<html lang='fr'>
  <head>
    <% include includes/head-global %>
    <% include includes/head-bootstrap %>
    <title><%= targetTitle%></title>
  </head>
  <body id='mybody' onload='initPage()'>
    <!-- Title line -->
    <div class='row'>
      <div class='col-sm-12'><h1><%= targetTitle%></h1></div>
    </div>
    <!-- Target background image -->
    <div class='row'>
      <div class='col-sm-12'>
        <svg class='targetImage' width='600' height='600' viewBox='0 0 600 600'>
          <image xlink:href='<%= targetImage%>' id='targetBackground'/>
          <circle id='initI'
            cx='0' cy='0' r='1'
            stroke='black' stroke-width='3' fill='Lime'/>
          <circle id='finalI'
            cx='0' cy='0' r='1'
            stroke='black' stroke-width='3' fill='Crimson'/>
        </svg>

      </div>
    </div>
    <!-- Legend -->
    <div class='row'><div class='col-sm-12'>Legend</div></div>
    <!-- Distance (included result zone)-->
    <div class='row'>
      <div class='col-sm-3'>Distance: </div>
      <div class='col-sm-3' id='dist'></div>
      <div class='col-sm-6' id='zonehit'></div>
    </div>
    <!-- Debug : show initial impact, adjustment -->
    <div class='row' >
      <div id='debug' class='col-sm-4'>
        Initial impact
      </div>
      <div class='col-sm-2'>Adjustement <%= targetAdjustement%></div>
    </div>
    <!-- Send -->
    <div class='row'>
      <div class='col-sm-12'>
        <button type='button' class='btn btn-primary'>
          Send Adjusted Impact
        </button>
      </div>
    </div>
  </body>

<script>
  var onclick = ((x) => {
    // TODO: Check that the impact is not out of bound

    // Calculate distance to the initial impact
    var dist = distanceToImpact(x.clientX, x.clientY)
    document.getElementById('dist').innerHTML = 'Distance : ' + dist.toString()

    // Display the new target
    var rec = document.getElementById('targetBackground').getBoundingClientRect()
    placeImpact('finalI', x.clientX-rec.left, x.clientY-rec.top)
  })


  // Manage roolover on the backgtroung image
  document.getElementById('targetBackground').addEventListener('onclick', onclick)
  var squareSize = <%= targetSquareSize %>

  var squareToPixel = ((x) => {
    return (x-0.5) * squareSize
  })

  var pixelToSquare = ((x) => {
    return  Math.floor(x / squareSize) + 1
  })

 var distanceToImpact = ((x,y) => {
   var rec = document.getElementById('targetBackground').getBoundingClientRect()
   return Math.abs(<%= targetIImpX %> - pixelToSquare(x-rec.left)) +
          Math.abs(<%= targetIImpY %> - pixelToSquare(y-rec.top))
 })
  var placeImpact = ((element, px, py) => {
    document.getElementById(element).setAttribute('cx', px)
    document.getElementById(element).setAttribute('cy', py)
    document.getElementById(element).setAttribute('r', squareSize/2)
  })

  var initPage = (() => {
    placeImpact('initI',
      squareToPixel(<%= targetIImpX %>),
      squareToPixel(<%= targetIImpY %>))
  })

</script>
</html>
